Following is how documents are stored in database.


# Holes Collection
All the neccessary information about a hole is stored here.

From a hole document, you can go further find:
* its comments
* other holes which are citing this hole
* profile and role of the author
* etc.

in other collections.

```json
{
  "publish_time": "Sun Nov 09 13:41:00 +0800 2014",
  "text": "Hello Treehole! :smile:",
  "images": [ "1123hopafsd092asd3" ],
  "author_id": "xiao_wang",
  "feedbacks": [
    {
      "type": "vote",
      "text": "like",
      "count": 10
    },
    {
      "type": "vote",
      "text": "dislike",
      "count": 5
    },
  ],
  "references": [
    {"hole_id": "545efe74a98d930013da8c02"},
    {"hole_id": "545efe74a98d930013da8c03"},
    {"url": "http://github.com/mulab", "text": "Lab mU"}
  ],
  "options": {
    "anonymous": true,
    "channel_id": "testChannel"
  }
}
```

| Field       | Description | Must Exist | Index |
| ----------- | ----------- | ---------- | ----- |
| `_id`       | This field is generated by mongodb. It is a BSON ID (e.g. `545efe76a98d930012da6d4b`) which is mono-increase w.r.t. insertion. | Default | Default |
| `images`    | Use provided id you can go to retrieve hosted images. E.g. <http://img.lab.mu/1123hopafsd092asd3?format=png&size=medium>. | No | No |
| `author_id`       | You can use this user ID to lookup detailed info in *Users Collection*. | Yes | Yes |
| `feedbacks` | Detailed information and statistics of feedback buttons. | No | No |
| `options`   | Contains options about where to publish, visibility etc. If `anonymous` is `true`, the unique role for the author can be found in *Roles Collection*. | Yes | Yes |


# Comments Collection
Each comment is a document which is stored out of its hole document - here in a collection.

However, to determine whether to show an anonymous user or real name, one should check the `option`. If the display should be anonymous, then go and find according role based on `from_user.uid` and `hole_id`.

``` json
{
  "post_time": "Sun Nov 09 17:56:55 +0800 2014",
  "text": "This is a simple comment",
  "hole_id": "545efe76a98d930012da6d4b",
  "from_user": "Alice",
  "reply_to": "545e28a80000000000000000",
  "votes": {
    "up": 10,
    "down": 1
  },
  "options": {
    "anonymous": true,
    "secret": false
  }
}
```

| Field       | Description |
| ----------- | ----------- |
| `_id`       | This field is generated by mongodb. E.g. `545f28a80000000000000000`. |
| `from_user` | User ID for author of this comment |
| `reply_to`  | Comment ID for recipient of this comment. This field can be omitted if the comment is directly reply to the hole. |
| `options`   | If this comment will show anonymously. And is this is a secret comment reply to someone... |


# Users Collection
Describe basic user information, and the binding with other school/social accounts.

This forms the basis of a profile page for each student.

```json
{
  "uid": "xiao_wang",
  "join_time": "Tue May 10 23:46:55 +0800 2011",
  "screen_name": "王霸之气",
  "contact_info": {
    "email": "xiao.wang@163.com",
    "mobile": "112341234432"
  },
  "links": [
    {"url": "http://xiaowang.io", "text": "个人博客"},
    {"url": "http://linkedin.com/xiaowang"}
  ],
  "tsinghua_account": {
    "student_number": "2014311111",
    "student_id": "xiaowang14",
    "real_name": "小王",
    "student_type": "博士",
    "gender": "男",
    "department": "交叉信息研究院",
    "email": "xiao.wang@gmail.com",
    "mobile": "+8612341234432"
  },
  "wechat_account": {
  },
  "renren_account": {
  },
  "weibo_account": {
    "uid": "12341234",
    "expires_in": "1234",
    "access_token": "ACCESS_TOKEN"
  }
}
```


# Roles Collection
For each user, s/he can have an unique anonymous role under a hole.

```json
{
  "user": "xiao_wang",
  "hole": "545efe76a98d930012da6d4b",
  "avatar": "19208asfio102h9x21",
  "text": "楼主"
}
```

| Field       | Description |
| ----------- | ----------- |
| `user`      | The real user behind this role |
| `hole`      | Under which hole the role is available |
| `avatar`    | Reference to a picture to be displayed as an avatar |
| `text`      | Name to distinguish this role from others |


# Channels Collection
Configurations and descriptions of each channel.

```json
{
  "channel_id": "testChannel",
  "screen_name": "Test Channel",
  "description": "This is a channel for debugging!",
  "sub_channels": [33, 35, 39],
  "options": {
    "default_pulish_anonymous": true,
    "default_comment_anonymous": false,
    "default_feedbacks": [
      {"type": "vote", "text": ":+1:"},
      {"type": "vote", "text": ":-1:"}
    ]
  }
}
```


# References Collection
This collection is for the sake of reverse reference searching: find which holes are my referrers.

```json
{
  "referrer": "545efe76a98d930012da6d4b",
  "reference": "545efe74a98d930013da8c03"
}
```
```json
{
  "referrer": "545efe76a98d930012da6d4b",
  "reference": "545efe74a98d930013da8c02"
}
```
